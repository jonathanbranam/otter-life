<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otter Adventure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #1a1a2e;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        #game-wrapper {
            position: relative;
            width: 100vmin;
            height: 100vmin;
            max-width: 800px;
            max-height: 800px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #game-container {
            border: 4px solid #0f3460;
            width: 100%;
            height: 100%;
            position: relative;
        }
        #game-container canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 5px;
            z-index: 100;
        }
        #controls {
            position: fixed;
            bottom: 210px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            align-items: flex-end;
            z-index: 100;
        }
        .joystick-container {
            position: relative;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #0f3460;
            border-radius: 50%;
            touch-action: none;
        }
        .joystick-knob {
            position: absolute;
            width: 50px;
            height: 50px;
            background: #4A90E2;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            border: 2px solid #0f3460;
        }
        .joystick-knob:active {
            cursor: grabbing;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .control-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #0f3460;
            background: #E74C3C;
            color: white;
            font-weight: bold;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            touch-action: manipulation;
            transition: background 0.1s;
        }
        .control-button:active {
            background: #C0392B;
        }
        .control-button.jump {
            width: 60px;
            height: 60px;
            background: #27AE60;
        }
        .control-button.jump:active {
            background: #229954;
        }
        #dialogue-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: rgba(0, 0, 0, 0.9);
            border-top: 3px solid #0f3460;
            display: none;
            z-index: 200;
            padding: 20px;
            box-sizing: border-box;
        }
        #dialogue-overlay.active {
            display: flex;
        }
        .dialogue-container {
            display: flex;
            gap: 20px;
            width: 100%;
            align-items: center;
        }
        .otter-portrait {
            width: 150px;
            height: 150px;
            background: #4A90E2;
            border: 3px solid #0f3460;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .otter-portrait canvas {
            width: 120px;
            height: 120px;
        }
        .dialogue-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .dialogue-text {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #0f3460;
            border-radius: 8px;
            padding: 15px;
            color: white;
            font-size: 16px;
            line-height: 1.5;
            min-height: 80px;
        }
        .dialogue-button {
            align-self: flex-end;
            padding: 10px 30px;
            background: #27AE60;
            border: 2px solid #0f3460;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .dialogue-button:hover {
            background: #229954;
        }
        .dialogue-button:active {
            background: #1e8449;
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 850px) {
            #game-wrapper {
                max-width: 100vmin;
                max-height: 100vmin;
            }
            #game-container {
                border-width: 2px;
            }
            #controls {
                bottom: 200px;
                gap: 15px;
            }
            .joystick-container {
                width: 100px;
                height: 100px;
            }
            .joystick-knob {
                width: 40px;
                height: 40px;
            }
            .otter-portrait {
                width: 100px;
                height: 100px;
            }
            .otter-portrait canvas {
                width: 80px;
                height: 80px;
            }
            .dialogue-text {
                font-size: 14px;
                padding: 10px;
                min-height: 60px;
            }
            .dialogue-button {
                padding: 8px 20px;
                font-size: 14px;
            }
            #dialogue-overlay {
                height: 180px;
                padding: 15px;
            }
            #info {
                font-size: 10px;
                padding: 6px;
            }
        }
        
        @media (max-width: 480px) {
            .dialogue-container {
                gap: 10px;
            }
            .otter-portrait {
                width: 80px;
                height: 80px;
            }
            .otter-portrait canvas {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container"></div>
        <div id="info">
            <p>Keyboard: Arrow Keys/WASD | Gamepad: D-Pad/Stick | Move otter around!</p>
        </div>
        <div id="controls">
            <div class="joystick-container">
                <div class="joystick-knob"></div>
            </div>
        </div>
        <div id="dialogue-overlay">
            <div class="dialogue-container">
                <div class="otter-portrait" id="otter-portrait">
                    <!-- Otter image will be inserted here -->
                </div>
                <div class="dialogue-content">
                    <div class="dialogue-text" id="dialogue-text">
                        Hello there!
                    </div>
                    <button class="dialogue-button" id="dialogue-ok">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class OtterScene extends Phaser.Scene {
            constructor() {
                super({ key: 'OtterScene' });
            }

            create() {
                // Define tile size (half the previous size)
                this.tileSize = 25; // Decreased from 50 to 25
                this.gridWidth = Math.floor(800 / this.tileSize); // 32 tiles wide
                this.gridHeight = Math.floor(800 / this.tileSize); // 32 tiles high
                
                // Background - sky
                this.add.rectangle(400, 400, 800, 800, 0x87CEEB);
                
                // Draw grass banks on top and bottom
                this.add.rectangle(400, 150, 800, 300, 0x4CAF50); // Top grass (bigger)
                this.add.rectangle(400, 650, 800, 300, 0x4CAF50); // Bottom grass (bigger)
                
                // Draw river in the middle
                this.add.rectangle(400, 400, 800, 300, 0x4A90E2); // River water
                
                // Add some river details (darker water ripples)
                for (let i = 0; i < 15; i++) {
                    const x = Phaser.Math.Between(0, 800);
                    const y = Phaser.Math.Between(250, 550);
                    this.add.ellipse(x, y, 50, 25, 0x3A7BC8, 0.3);
                }
                
                // Add some grass detail on banks
                for (let i = 0; i < 20; i++) {
                    const x = Phaser.Math.Between(0, 800);
                    const yTop = Phaser.Math.Between(50, 200);
                    const yBottom = Phaser.Math.Between(600, 750);
                    this.add.circle(x, yTop, 6, 0x2E7D32);
                    this.add.circle(x, yBottom, 6, 0x2E7D32);
                }

                // Optional: Draw debug grid (comment out to hide)
                // this.drawGrid();

                // Create different otter textures with different colors
                this.createOtterTextures();

                // Create player otter sprite (doubled from 0.5 to 1.0)
                this.otter = this.add.sprite(0, 0, 'otter-brown');
                this.otter.setScale(1.0); // Doubled from 0.5

                // Create NPC otters
                this.npcOtters = [];
                this.createNPCOtters();

                // Grid-based movement variables
                this.otterGridX = Math.floor(this.gridWidth / 2); // Start in middle
                this.otterGridY = Math.floor(this.gridHeight / 2);
                this.isMoving = false;
                this.moveSpeed = 200; // pixels per second for smooth interpolation
                this.targetX = 0;
                this.targetY = 0;
                
                // Set initial position
                this.updateOtterPosition();

                // Input setup
                this.cursors = this.input.keyboard.createCursorKeys();
                this.keys = {
                    w: this.input.keyboard.addKey('W'),
                    a: this.input.keyboard.addKey('A'),
                    s: this.input.keyboard.addKey('S'),
                    d: this.input.keyboard.addKey('D')
                };

                // Track if keys were just pressed (for one move per press)
                this.lastMoveTime = 0;
                this.moveDelay = 150; // milliseconds between moves

                // Text display
                this.speedText = this.add.text(10, 10, '', { font: '16px Arial', fill: '#fff' });
            }

            drawGrid() {
                // Helper function to visualize the grid (optional)
                const graphics = this.add.graphics();
                graphics.lineStyle(1, 0xffffff, 0.2);
                
                for (let x = 0; x <= this.gridWidth; x++) {
                    graphics.lineBetween(x * this.tileSize, 0, x * this.tileSize, 800);
                }
                for (let y = 0; y <= this.gridHeight; y++) {
                    graphics.lineBetween(0, y * this.tileSize, 800, y * this.tileSize);
                }
            }

            createOtterTextures() {
                // Create different colored otter textures with hideous designs
                const otterColors = [
                    { name: 'otter-brown', color: 0x4A3219, wart: 0x2F1F0A },      // Murky brown
                    { name: 'otter-dark', color: 0x3D2817, wart: 0x1A0F06 },       // Sickly dark brown
                    { name: 'otter-light', color: 0x6B5C4D, wart: 0x4A3F34 },      // Diseased light brown
                    { name: 'otter-gray', color: 0x5C5C5C, wart: 0x3A3A3A },       // Grimy gray
                    { name: 'otter-tan', color: 0x9C8B6F, wart: 0x6F6049 }         // Splotchy tan
                ];

                otterColors.forEach(({ name, color, wart }) => {
                    const graphics = this.make.graphics({ x: 0, y: 0, add: false });
                    
                    // Lumpy, misshapen body
                    graphics.fillStyle(color, 1);
                    graphics.fillCircle(50, 58, 19);
                    graphics.fillCircle(45, 55, 12); // Lump
                    graphics.fillCircle(58, 62, 8);  // Another lump
                    
                    // Grotesque patches
                    graphics.fillStyle(wart, 1);
                    graphics.fillCircle(42, 60, 5);
                    graphics.fillCircle(56, 54, 4);
                    graphics.fillCircle(48, 68, 3);
                    
                    // Twisted, asymmetric arms
                    graphics.fillStyle(color, 1);
                    graphics.fillCircle(35, 62, 7); // Left arm too long
                    graphics.fillCircle(61, 56, 4); // Right arm too short
                    
                    // Disgusting, scraggly tail
                    graphics.fillCircle(52, 75, 6);
                    graphics.fillCircle(54, 80, 4);
                    graphics.fillCircle(50, 82, 2);
                    
                    // Deformed head - too big and lopsided
                    graphics.fillCircle(48, 33, 16);
                    graphics.fillCircle(54, 30, 10); // Bulge on one side
                    
                    // Mangy, uneven ears
                    graphics.fillCircle(40, 20, 6); // One ear bigger
                    graphics.fillCircle(58, 22, 3); // One ear smaller
                    
                    // Hideous mismatched eyes - different sizes and heights
                    graphics.fillStyle(0x000000, 1);
                    graphics.fillCircle(42, 30, 5);  // Left eye huge and bulging
                    graphics.fillCircle(56, 34, 2);  // Right eye tiny and lower
                    
                    // Bloodshot/crazed look
                    graphics.lineStyle(1, 0x8B0000, 0.8);
                    graphics.strokeCircle(42, 30, 6);
                    
                    // Creepy uneven pupils
                    graphics.fillStyle(0xFFFFFF, 1);
                    graphics.fillCircle(40, 29, 1.5);
                    graphics.fillCircle(56.5, 34, 0.8);
                    
                    // Crooked, misshapen nose/snout
                    graphics.fillStyle(wart, 1);
                    graphics.fillCircle(47, 40, 3);
                    graphics.fillCircle(51, 41, 2);
                    
                    // Random warts and blemishes
                    graphics.fillCircle(38, 36, 1.5);
                    graphics.fillCircle(60, 28, 1);
                    graphics.fillCircle(44, 24, 1.2);
                    graphics.fillCircle(52, 44, 1.8);
                    graphics.fillCircle(36, 50, 1.3);
                    
                    // Asymmetric mouth/grimace
                    graphics.lineStyle(2, 0x000000, 1);
                    graphics.beginPath();
                    graphics.arc(48, 42, 4, 0.2, Math.PI - 0.5);
                    graphics.strokePath();
                    
                    graphics.generateTexture(name, 100, 100);
                    graphics.destroy();
                });
            }

            createNPCOtters() {
                // Define different otter types with textures and sizes (doubled)
                const otterTypes = [
                    { texture: 'otter-dark', scale: 0.9 },   // Doubled from 0.45
                    { texture: 'otter-light', scale: 1.1 },  // Doubled from 0.55
                    { texture: 'otter-gray', scale: 0.96 },  // Doubled from 0.48
                    { texture: 'otter-tan', scale: 1.04 }    // Doubled from 0.52
                ];

                // Place otters in the water (middle area, rows 10-22)
                for (let i = 0; i < 5; i++) {
                    const type = Phaser.Utils.Array.GetRandom(otterTypes);
                    const gridX = Phaser.Math.Between(2, this.gridWidth - 3);
                    const gridY = Phaser.Math.Between(10, 22); // Water area (adjusted for new grid)
                    
                    const npcOtter = this.add.sprite(
                        gridX * this.tileSize + this.tileSize / 2,
                        gridY * this.tileSize + this.tileSize / 2,
                        type.texture
                    );
                    npcOtter.setScale(type.scale);
                    npcOtter.setDepth(1); // Behind player
                    
                    this.npcOtters.push({
                        sprite: npcOtter,
                        gridX: gridX,
                        gridY: gridY
                    });
                }

                // Place otters on top grass bank (rows 0-8)
                for (let i = 0; i < 3; i++) {
                    const type = Phaser.Utils.Array.GetRandom(otterTypes);
                    const gridX = Phaser.Math.Between(2, this.gridWidth - 3);
                    const gridY = Phaser.Math.Between(0, 8); // Top grass (adjusted for new grid)
                    
                    const npcOtter = this.add.sprite(
                        gridX * this.tileSize + this.tileSize / 2,
                        gridY * this.tileSize + this.tileSize / 2,
                        type.texture
                    );
                    npcOtter.setScale(type.scale);
                    npcOtter.setDepth(1);
                    
                    this.npcOtters.push({
                        sprite: npcOtter,
                        gridX: gridX,
                        gridY: gridY
                    });
                }

                // Place otters on bottom grass bank (rows 24-31)
                for (let i = 0; i < 3; i++) {
                    const type = Phaser.Utils.Array.GetRandom(otterTypes);
                    const gridX = Phaser.Math.Between(2, this.gridWidth - 3);
                    const gridY = Phaser.Math.Between(24, 31); // Bottom grass (adjusted for new grid)
                    
                    const npcOtter = this.add.sprite(
                        gridX * this.tileSize + this.tileSize / 2,
                        gridY * this.tileSize + this.tileSize / 2,
                        type.texture
                    );
                    npcOtter.setScale(type.scale);
                    npcOtter.setDepth(1);
                    
                    this.npcOtters.push({
                        sprite: npcOtter,
                        gridX: gridX,
                        gridY: gridY
                    });
                }

                // Set player otter depth to be on top
                this.otter.setDepth(2);
            }

            getRandomDialogue() {
                const dialogues = [
                    "Hey there! The water's great today!",
                    "Have you seen any fish around here?",
                    "I love floating on my back!",
                    "Did you know otters hold hands while sleeping?",
                    "These rocks are perfect for cracking open shellfish!",
                    "The current is especially nice downstream.",
                    "I found the best sliding spot earlier!",
                    "Nothing beats a good swim in the morning!",
                    "Have you tried catching crawfish? They're delicious!",
                    "I'm just taking a little break on the bank.",
                    "The water temperature is perfect right now!",
                    "Want to race to the other side?",
                    "I saw a family of ducks earlier, so cute!",
                    "This is my favorite spot to relax.",
                    "The fish are really active today!",
                    "I love living by this river!",
                    "Sometimes I just float and watch the clouds.",
                    "Have you explored the whole river yet?",
                    "I'm looking for smooth pebbles for my collection!",
                    "Nice day for a swim, isn't it?"
                ];
                return Phaser.Utils.Array.GetRandom(dialogues);
            }

            checkNearbyOtters() {
                // Only check if player is completely stopped
                if (this.isMoving) {
                    return; // Don't trigger dialogue while moving
                }
                
                // Check if player is near any NPC otter (within 0.5 tiles - very close)
                for (let npc of this.npcOtters) {
                    const distX = Math.abs(this.otterGridX - npc.gridX);
                    const distY = Math.abs(this.otterGridY - npc.gridY);
                    const distance = Math.sqrt(distX * distX + distY * distY);
                    
                    if (distance <= 0.5) {
                        // Show dialogue only if stopped and very close
                        this.showDialogue(npc);
                        return;
                    }
                }
            }

            showDialogue(npc) {
                // Pause the game
                this.scene.pause();
                
                // Get the dialogue overlay elements
                const overlay = document.getElementById('dialogue-overlay');
                const portraitDiv = document.getElementById('otter-portrait');
                const dialogueText = document.getElementById('dialogue-text');
                
                // Clear previous portrait
                portraitDiv.innerHTML = '';
                
                // Create a canvas for the otter portrait (larger version)
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // Get the otter's texture color from its key
                const textureKey = npc.sprite.texture.key;
                let otterColor = 0x8B4513; // default brown
                
                if (textureKey.includes('dark')) otterColor = 0x654321;
                else if (textureKey.includes('light')) otterColor = 0xA0826D;
                else if (textureKey.includes('gray')) otterColor = 0x808080;
                else if (textureKey.includes('tan')) otterColor = 0xD2B48C;
                
                // Draw larger otter portrait
                ctx.fillStyle = '#' + otterColor.toString(16).padStart(6, '0');
                
                // Scale up for portrait (2x size)
                const scale = 2;
                
                // Otter body
                ctx.beginPath();
                ctx.arc(100, 100, 24 * scale, 0, Math.PI * 2);
                ctx.fill();
                
                // Otter head
                ctx.beginPath();
                ctx.arc(100, 70, 18 * scale, 0, Math.PI * 2);
                ctx.fill();
                
                // Eyes
                ctx.fillStyle = '#000000';
                ctx.beginPath();
                ctx.arc(94, 64, 4 * scale, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(106, 64, 4 * scale, 0, Math.PI * 2);
                ctx.fill();
                
                // Ears
                ctx.fillStyle = '#' + otterColor.toString(16).padStart(6, '0');
                ctx.beginPath();
                ctx.arc(90, 56, 6 * scale, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(110, 56, 6 * scale, 0, Math.PI * 2);
                ctx.fill();
                
                // Tail
                ctx.beginPath();
                ctx.arc(116, 104, 14 * scale, 0, Math.PI * 2);
                ctx.fill();
                
                portraitDiv.appendChild(canvas);
                
                // Set random dialogue
                dialogueText.textContent = this.getRandomDialogue();
                
                // Show overlay
                overlay.classList.add('active');
            }

            updateOtterPosition() {
                // Update target position based on grid coordinates
                this.targetX = this.otterGridX * this.tileSize + this.tileSize / 2;
                this.targetY = this.otterGridY * this.tileSize + this.tileSize / 2;
            }

            moveOtterToGrid(deltaX, deltaY) {
                if (this.isMoving) return; // Don't move if already moving

                const newGridX = this.otterGridX + deltaX;
                const newGridY = this.otterGridY + deltaY;

                // Check bounds
                if (newGridX >= 0 && newGridX < this.gridWidth && 
                    newGridY >= 0 && newGridY < this.gridHeight) {
                    this.otterGridX = newGridX;
                    this.otterGridY = newGridY;
                    this.updateOtterPosition();
                    this.isMoving = true;
                }
            }

            update(time, delta) {
                // Store virtual controls state from global scope
                if (typeof window.virtualJoystick !== 'undefined') {
                    this.virtualJoystickX = window.virtualJoystick.x;
                    this.virtualJoystickY = window.virtualJoystick.y;
                } else {
                    this.virtualJoystickX = 0;
                    this.virtualJoystickY = 0;
                }

                // Smooth movement towards target
                if (this.isMoving) {
                    const dx = this.targetX - this.otter.x;
                    const dy = this.targetY - this.otter.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 2) {
                        // Snap to target when close enough
                        this.otter.x = this.targetX;
                        this.otter.y = this.targetY;
                        this.isMoving = false;
                        
                        // Check for nearby otters when movement stops
                        this.checkNearbyOtters();
                    } else {
                        // Move smoothly towards target
                        const moveAmount = (this.moveSpeed * delta) / 1000;
                        const ratio = Math.min(moveAmount / distance, 1);
                        this.otter.x += dx * ratio;
                        this.otter.y += dy * ratio;
                    }
                }

                // Only accept new movement input if not currently moving and enough time has passed
                if (!this.isMoving && time > this.lastMoveTime + this.moveDelay) {
                    let moved = false;

                    // Virtual joystick input (highest priority)
                    if (Math.abs(this.virtualJoystickX) > 0.3) {
                        if (this.virtualJoystickX > 0) {
                            this.moveOtterToGrid(1, 0);
                            moved = true;
                        } else {
                            this.moveOtterToGrid(-1, 0);
                            moved = true;
                        }
                    } else if (Math.abs(this.virtualJoystickY) > 0.3) {
                        if (this.virtualJoystickY > 0) {
                            this.moveOtterToGrid(0, 1);
                            moved = true;
                        } else {
                            this.moveOtterToGrid(0, -1);
                            moved = true;
                        }
                    }
                    // Keyboard input (fallback)
                    else if (this.cursors.left.isDown || this.keys.a.isDown) {
                        this.moveOtterToGrid(-1, 0);
                        moved = true;
                    } else if (this.cursors.right.isDown || this.keys.d.isDown) {
                        this.moveOtterToGrid(1, 0);
                        moved = true;
                    } else if (this.cursors.up.isDown || this.keys.w.isDown) {
                        this.moveOtterToGrid(0, -1);
                        moved = true;
                    } else if (this.cursors.down.isDown || this.keys.s.isDown) {
                        this.moveOtterToGrid(0, 1);
                        moved = true;
                    }

                    // Gamepad input
                    const gamepads = this.input.gamepad.gamepads;
                    if (gamepads[0] && !moved) {
                        const pad = gamepads[0];
                        const threshold = 0.3;

                        // D-Pad or Analog stick
                        if (pad.left || pad.dpadLeft || (pad.axes[0] && pad.axes[0].value < -threshold)) {
                            this.moveOtterToGrid(-1, 0);
                            moved = true;
                        } else if (pad.right || pad.dpadRight || (pad.axes[0] && pad.axes[0].value > threshold)) {
                            this.moveOtterToGrid(1, 0);
                            moved = true;
                        } else if (pad.up || pad.dpadUp || (pad.axes[1] && pad.axes[1].value < -threshold)) {
                            this.moveOtterToGrid(0, -1);
                            moved = true;
                        } else if (pad.down || pad.dpadDown || (pad.axes[1] && pad.axes[1].value > threshold)) {
                            this.moveOtterToGrid(0, 1);
                            moved = true;
                        }
                    }

                    if (moved) {
                        this.lastMoveTime = time;
                    }
                }

                // Update debug text
                this.speedText.setText(`Grid: (${this.otterGridX}, ${this.otterGridY}) | Position: (${Math.round(this.otter.x)}, ${Math.round(this.otter.y)})`);
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 800,
            parent: 'game-container',
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH,
                width: 800,
                height: 800
            },
            scene: OtterScene,
            input: {
                gamepad: true
            }
        };

        const game = new Phaser.Game(config);

        // Virtual Controls Setup - Use global state
        window.virtualJoystick = {
            x: 0,
            y: 0,
            jumpPressed: false
        };

        const joystickContainer = document.querySelector('.joystick-container');
        const joystickKnob = document.querySelector('.joystick-knob');

        // Virtual joystick state
        let joystickActive = false;
        const maxDistance = 35; // Maximum distance from center

        // Handle joystick drag
        function handleJoystickStart(e) {
            joystickActive = true;
            updateJoystick(e);
        }

        function handleJoystickMove(e) {
            if (!joystickActive) return;
            e.preventDefault();
            updateJoystick(e);
        }

        function handleJoystickEnd() {
            joystickActive = false;
            window.virtualJoystick.x = 0;
            window.virtualJoystick.y = 0;
            joystickKnob.style.transform = 'translate(-50%, -50%)';
        }

        function updateJoystick(e) {
            const rect = joystickContainer.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            let clientX, clientY;
            if (e.type.includes('touch')) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            let deltaX = clientX - centerX;
            let deltaY = clientY - centerY;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

            if (distance > maxDistance) {
                const angle = Math.atan2(deltaY, deltaX);
                deltaX = Math.cos(angle) * maxDistance;
                deltaY = Math.sin(angle) * maxDistance;
            }

            window.virtualJoystick.x = deltaX / maxDistance;
            window.virtualJoystick.y = deltaY / maxDistance;

            joystickKnob.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
        }

        // Joystick event listeners
        joystickContainer.addEventListener('mousedown', handleJoystickStart);
        joystickContainer.addEventListener('touchstart', handleJoystickStart);
        document.addEventListener('mousemove', handleJoystickMove);
        document.addEventListener('touchmove', handleJoystickMove, { passive: false });
        document.addEventListener('mouseup', handleJoystickEnd);
        document.addEventListener('touchend', handleJoystickEnd);

        // Dialogue OK button handler
        document.getElementById('dialogue-ok').addEventListener('click', function() {
            const overlay = document.getElementById('dialogue-overlay');
            overlay.classList.remove('active');
            
            // Resume the game
            const scene = game.scene.scenes[0];
            if (scene.scene.isPaused()) {
                scene.scene.resume();
            }
        });
    </script>
</body>
</html>
